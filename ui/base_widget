import pygame
from logging_system import write_log
import config

pygame.init()

# Fenster
screen = pygame.display.set_mode((config.WIDTH, config.HEIGHT))
pygame.display.set_caption(config.WINDOW_TITLE)

font = pygame.font.SysFont(None, config.FONT_SIZE)
clock = pygame.time.Clock()

current_user = config.DEFAULT_USER

# Raum-Klasse
class Room:
    def __init__(self, rect, window_rect, name):
        self.rect = rect
        self.window = window_rect
        self.light_on = True
        self.rollo_height = 0
        self.name = name

    def toggle_light(self, user):
        self.light_on = not self.light_on
        action = f"{self.name}: Licht {'AN' if self.light_on else 'AUS'}"
        write_log(user, action)

    def rollo_up(self, user):
        self.rollo_height = max(0, self.rollo_height - 5)
        write_log(user, f"{self.name}: Rollo hoch")

    def rollo_down(self, user):
        self.rollo_height = min(self.window.height, self.rollo_height + 5)
        write_log(user, f"{self.name}: Rollo runter")

    def draw(self, surface):
        pygame.draw.rect(surface, config.FLOOR, self.rect)
        pygame.draw.rect(surface, config.WALL, self.rect, 4)

        pygame.draw.rect(surface, config.WINDOW, self.window)

        rollo_rect = pygame.Rect(
            self.window.x,
            self.window.y,
            self.window.width,
            self.rollo_height
        )
        pygame.draw.rect(surface, config.ROLLO, rollo_rect)

        if not self.light_on:
            dark = pygame.Surface((self.rect.width, self.rect.height), pygame.SRCALPHA)
            dark.fill(config.DARK)
            surface.blit(dark, self.rect.topleft)


# RÃ¤ume korrekt erzeugen
rooms ={
    "room_1": room_1,
    "room_2": room_2,

}



# Hauptloop
running = True
while running:
    for event in pygame.event.get():
        if event.type == pygame.QUIT:
            running = False

        if event.type == pygame.KEYDOWN:
            if event.key in config.KEYS:
                target, action = config.KEYS[event.key]

            # Raum-Aktionen
            if target in rooms:
                room = rooms[target]
                getattr(room,action)(current_user)

          # Benutzer wechseln
        elif target == "user":
            current_user = action
            write_log(current_user, f"Benutzer gewechselt zu {current_user}")

            if event.key == pygame.K_o:
                current_user = "user_b"
                write_log(current_user, "Benutzer gewechselt zu user_b")

    # Bildschirm JEDEN FRAME neu zeichnen
    screen.fill(config.BACKGROUND)
    room_1.draw(screen)
    room_2.draw(screen)

    # Benutzer anzeigen
    user_text = font.render(f"Aktueller Benutzer: {current_user}", True, (255, 255, 255))
    screen.blit(user_text, (20, 20))

    pygame.display.flip()
    clock.tick(config.FPS)

pygame.quit()
